<%- include('layouts/header.ejs') %>
<h2 class="mb-4">Hii, <%= user.name %></h2>

<div class="row">
    <div class="col-md-3">
        <ul class="list-group">
            <% if (users.length>0) { %>
             <% for( let i = 0; i < users.length ;++i) { %>
                <li class="list-group-item list-group-item-dark curser-pointer user-list" data-id="<%= users[i]._id %>">
                    <img src="<%= users[i].image %>" alt="" width="40px" height="40px">
                    <%= users[i].name %>
                    <% if (users[i].isOnline==='1') { %>
                        <sup class="online-status" id="<%= users[i]._id %>-status">Online</sup>
                    <% } else { %>
                        <sup class="ofline-status" id="<%= users[i]._id %>-status">Ofline</sup>
                    <% } %>
                </li>
             <% } %>
            <% } %>
        </ul>
    </div>
    <div class="col-md-9">
        <h3 class="start-head">Click to Start Chat</h3>
        <div class="chat-section">
            <div id="chat-container">
                <!-- <div class="current-user-chat">
                    <span class="chats">Hii</span>
                </div>
                <div class="distance-user-chat">
                    <span class="chats">Hiii</span>
                </div> -->
            </div>
            <form action="" id="chat-form">
                <input type="text" name="message" placeholder="Enter Message" class="border" id="message" required>
                <input type="submit" value="Send Message" class="btn btn-primary">
            </form>
        </div>
    </div>
</div>

<script>

    let sender_id='<%=  user._id %>';
    let receiver_id;
    let socket=io('/user-namespace',{
        auth:{
            token:sender_id
        }
    });

    // get user online status
    socket.on('getOnlineUser',(data)=>{
         $('#'+data.user_id+'-status').text("Online");
         $('#'+data.user_id+'-status').removeClass('ofline-status');
         $('#'+data.user_id+'-status').addClass("online-status");

    })

    socket.on('getOflineUser',(data)=>{
         $('#'+data.user_id+'-status').text("Ofline");
         $('#'+data.user_id+'-status').removeClass('online-status');
         $('#'+data.user_id+'-status').addClass("ofline-status");

    })

    $(document).ready(function(){
        $('.user-list').click(function(){
            let userId=$(this).attr('data-id');
            receiver_id=userId;
            $('.start-head').hide();
            $('.chat-section').show();
            socket.emit('existsChat',{sender_id: sender_id,receiver_id:receiver_id});
        })
    });

    // chat save of user
    $('#chat-form').submit((e)=>{
        e.preventDefault();
        let message=$('#message').val();
        // $('#message').val('');
        console.log('submitted');


        $.ajax({
            url:'/saveChat',
            type:'POST',
            data:{sender_id:sender_id,receiver_id:receiver_id,message:message},
            success: function(response){
                if(response.success){
                    $('#message').val("");
                    let chat=response.data.message;
                    let html=`
                        <div class="current-user-chat">
                            <span class="chats">${chat}</span>
                        </div>
                    `;
                    $('#chat-container').append(html);
                    socket.emit('newChat',response.data)
                    scrollChat();
                }else{
                    alert(response.msg);
                }
            }
        })

    })

    socket.on('loadNewChat',(data)=>{
        // console.log(data);
        if(sender_id==data.receiver_id && receiver_id==data.sender_id){
            let html=`
                <div class="distance-user-chat">
                    <span class="chats">${data.message}</span>
                </div>
            `;
            $('#chat-container').append(html);
            
        }
        scrollChat();
    })

    socket.on('loadChats',(data)=>{
        $('#chat-container').html('');
        let chats=data.chats;
        let html='';
        for(let i=0;i<chats.length;++i){
            let addClass='';
            if(chats[i].sender_id==sender_id){
                addClass=`
                    <div class="current-user-chat">
                        <span class="chats">${chats[i].message}</span>
                    </div>
                `;
            }else{
                addClass=`
                    <div class="distance-user-chat">
                        <span class="chats">${chats[i].message}</span>
                    </div>
                `;
            }
            html+=addClass;
        }
        $('#chat-container').append(html);
        scrollChat();
    })

    function scrollChat(){
        $('#chat-container').animate({
            scrollTop: $('$chat-container').offset().top+ $('$chat-container')[0].scrollHeight
        },0)
    }


    
</script>

<%- include('layouts/footer.ejs') %>